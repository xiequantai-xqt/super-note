# æŠ€æœ¯é€‰å‹

## æŠ€æœ¯æ¶æ„

| æ¨¡å—         | æŠ€æœ¯é€‰å‹                                              |
| ------------ | ----------------------------------------------------- |
| **å‰ç«¯**     | Ant Design Pro v5 + Umi 4 + TypeScript                |
| **åç«¯**     | NestJS 9 + TypeScript + TypeORM                       |
| **æ•°æ®åº“**   | PostgreSQL (ä¸»åº“) + Redis (ç¼“å­˜/ä¼šè¯)                 |
| **æ–‡ä»¶å­˜å‚¨** | MinIO (è‡ªæ‰˜ç®¡å¯¹è±¡å­˜å‚¨) + é˜¿é‡Œäº‘OSS/ç äº‘API (é•¿æœŸå­˜å‚¨) |
| **éƒ¨ç½²**     | Docker + Kubernetes (åç«¯) / Vercel (å‰ç«¯)            |
| **ç›‘æ§**     | Sentry (å‰ç«¯é”™è¯¯ç›‘æ§) + Prometheus/Grafana (åç«¯ç›‘æ§) |

## Ant Design Pro ä¼˜åŠ¿åˆ†æ
1. **å¼€ç®±å³ç”¨çš„åŠŸèƒ½**ï¼š
   - å†…ç½®ç”¨æˆ·ç®¡ç†/æƒé™æ§åˆ¶æ¨¡æ¿
   - é¢„ç½®ProComponentsé«˜çº§ç»„ä»¶(è¡¨æ ¼/è¡¨å•/å›¾è¡¨)
   - å†…ç½®å›½é™…åŒ–æ–¹æ¡ˆ
   - å®Œå–„çš„æƒé™è·¯ç”±ç³»ç»Ÿ

2. **æœ€ä½³å®è·µé›†æˆ**ï¼š
   
   ```mermaid
   graph LR
   A[Ant Design Pro] --> B[Umi è·¯ç”±]
   A --> C[Dva çŠ¶æ€ç®¡ç†]
   A --> D[Ant Design ç»„ä»¶åº“]
   A --> E[Mock æ•°æ®]
   A --> F[æ„å»ºéƒ¨ç½²]
   ```
   
3. **ä¸éœ€æ±‚å®Œç¾åŒ¹é…**ï¼š
   - å†…ç½®æƒé™ç®¡ç†æ–¹æ¡ˆ(`access.ts`)
   - é¢„åˆ¶å¤šç§å›¾è¡¨ç»„ä»¶(å¯¹æ¥ECharts)
   - è¡¨æ ¼å¯¼å‡ºåŠŸèƒ½(Excel/PDF)
   - å¤šè¯­è¨€æ”¯æŒ

## å…³é”®æ¨¡å—å®ç°æ–¹æ¡ˆ

### 1. ç”¨æˆ·ç³»ç»Ÿä¸æƒé™æ§åˆ¶
**å‰ç«¯å®ç°**ï¼š

```typescript
// src/access.ts
export default function access(initialState: { currentUser?: API.CurrentUser } {
  const { currentUser } = initialState || {};
  return {
    canAdmin: currentUser && currentUser.role === 'admin',
    canUpload: currentUser && currentUser.permissions.includes('file:upload'),
    // æ›´å¤šæƒé™ç‚¹...
  };
}

// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
const access = useAccess();
{access.canUpload && <UploadButton />}
```

**åç«¯RBACè®¾è®¡**ï¼š

```typescript
// è§’è‰²-æƒé™å…³è”
@Entity()
export class Role {
  @PrimaryGeneratedColumn()
  id: number;

  @Column({ unique: true })
  name: string; // admin/editor/viewer

  @Column('simple-array')
  permissions: string[]; // ['file:read', 'file:write']
}

// ç”¨æˆ·-è§’è‰²å…³è”
@Entity()
export class User {
  // ...
  @ManyToMany(() => Role)
  @JoinTable()
  roles: Role[];
}
```

### 2. æ–‡ä»¶ç®¡ç†ç³»ç»Ÿ
**å‰ç«¯ä¸Šä¼ ç»„ä»¶**ï¼š
```jsx
// src/pages/FileManager/components/UploadPanel.tsx
import { ProFormUploadButton } from '@ant-design/pro-components';

export default () => (
  <ProFormUploadButton
    name="file"
    label="æ–‡ä»¶ä¸Šä¼ "
    max={5}
    fieldProps={{
      name: 'file',
      beforeUpload: (file) => {
        // æ–‡ä»¶ç±»å‹éªŒè¯
        const isValid = ['image/png', 'application/pdf'].includes(file.type);
        if (!isValid) message.error('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹');
        return isValid;
      }
    }}
    action="/api/v1/files/upload"
  />
);
```

**åç«¯å­˜å‚¨ç­–ç•¥**ï¼š
```typescript
// ç­–ç•¥æ¨¡å¼å®ç°
interface StorageStrategy {
  upload(file: Express.Multer.File): Promise<string>;
}

@Injectable()
export class FileService {
  constructor(
    @Inject('TEMPORARY_STORAGE') private tempStorage: StorageStrategy,
    @Inject('LONGTERM_STORAGE') private longtermStorage: StorageStrategy
  ) {}

  async uploadFile(file: Express.Multer.File, isTemporary: boolean) {
    const strategy = isTemporary ? this.tempStorage : this.longtermStorage;
    return strategy.upload(file);
  }
}
```

### 3. æŠ¥è¡¨ä¸ä»ªè¡¨ç›˜
**Ant Design Pro å›¾è¡¨é›†æˆ**ï¼š
```jsx
// src/pages/Dashboard/Analysis.tsx
import { Column } from '@ant-design/charts';

export default () => {
  const [data, setData] = useState([]);

  useEffect(() => {
    fetchData().then(setData);
  }, []);

  const config = {
    data,
    xField: 'date',
    yField: 'value',
    seriesField: 'category',
    isGroup: true,
  };

  return (
    <ProCard>
      <Column {...config} />
      <ExportButtons onExport={handleExport} />
    </ProCard>
  );
};
```

## é¡¹ç›®ç»“æ„

```bash
# å‰ç«¯é¡¹ç›®ç»“æ„
tianshu-fe/
â”œâ”€â”€ config/            # Umié…ç½®
â”œâ”€â”€ mock/              # å‰ç«¯Mockæ•°æ®
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ pages/         # é¡µé¢ç»„ä»¶
â”‚   â”œâ”€â”€ services/      # APIæœåŠ¡
â”‚   â””â”€â”€ app.tsx        # è¿è¡Œæ—¶é…ç½®
â””â”€â”€ package.json

# åç«¯é¡¹ç›®ç»“æ„
tianshu-be/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ modules/       # ä¸šåŠ¡æ¨¡å—
â”‚   â”œâ”€â”€ shared/        # å…±äº«åº“
â”‚   â””â”€â”€ main.ts        # å…¥å£æ–‡ä»¶
â”œâ”€â”€ test/              # æµ‹è¯•ä»£ç 
â””â”€â”€ package.json
```

## å¼€å‘ä¸éƒ¨ç½²æµç¨‹

1. **æœ¬åœ°å¼€å‘**ï¼š
   ```bash
   # å‰ç«¯
   cd fe && npm install
   npm run start:dev
   
   # åç«¯
   cd be && npm install
   docker-compose up -d  # å¯åŠ¨DB/Redis/MinIO
   npm run start:dev
   ```

2. **ç”Ÿäº§éƒ¨ç½²**ï¼š
   ```mermaid
   graph LR
   A[GitHubä»“åº“] --> B[CI/CDæµæ°´çº¿]
   B --> C{ç¯å¢ƒåˆ¤æ–­}
   C -->|ç”Ÿäº§| D[æ„å»ºå‰ç«¯é™æ€æ–‡ä»¶]
   C -->|ç”Ÿäº§| E[æ„å»ºDockeré•œåƒ]
   D --> F[ä¸Šä¼ è‡³CDN]
   E --> G[éƒ¨ç½²åˆ°K8sé›†ç¾¤]
   ```

## ç‰¹åˆ«æ³¨æ„äº‹é¡¹

1. **Ant Design Pro å®šåˆ¶**ï¼š
   - ä¿®æ”¹ `src/app.tsx` é…ç½®è¯·æ±‚æ‹¦æˆªå™¨
   - åœ¨ `src/global.less` è¦†ç›–ä¸»é¢˜å˜é‡
   - ä½¿ç”¨ `@ant-design/pro-layout` å®šåˆ¶èœå•

2. **æƒé™åŒæ­¥æ–¹æ¡ˆ**ï¼š
   ```mermaid
   sequenceDiagram
     å‰ç«¯->>åç«¯: ç™»å½•è¯·æ±‚
     åç«¯->>å‰ç«¯: è¿”å›JWT + æƒé™åˆ—è¡¨
     å‰ç«¯->>å‰ç«¯: è®¾ç½®access.tsæƒé™
     å‰ç«¯->>åç«¯: å¸¦Tokençš„APIè¯·æ±‚
     åç«¯->>åç«¯: éªŒè¯æƒé™
   ```

3. **æ–‡ä»¶å­˜å‚¨è¿ç§»ç­–ç•¥**ï¼š
   - é˜¶æ®µ1ï¼šå…¨éƒ¨ä½¿ç”¨MinIO
   - é˜¶æ®µ2ï¼šæ·»åŠ å­˜å‚¨ç­–ç•¥å¼€å…³
   - é˜¶æ®µ3ï¼šå®ç°è‡ªåŠ¨å½’æ¡£(7å¤©æœªæ“ä½œæ–‡ä»¶â†’è½¬ç äº‘)

# åœ¨ä½¿ç”¨ant design proä¹‹å‰ï¼Œéœ€è¦å­¦ä¹ ä»€ä¹ˆï¼Ÿ

## æ ¸å¿ƒå‰ç½®çŸ¥è¯†ä½“ç³»

| çŸ¥è¯†é¢†åŸŸ       | å…·ä½“å†…å®¹                                                 | é‡è¦æ€§ | å­¦ä¹ èµ„æº                                                     | æŒæ¡ç¨‹åº¦ |
| -------------- | -------------------------------------------------------- | ------ | ------------------------------------------------------------ | -------- |
| **React åŸºç¡€** | ç»„ä»¶åŒ–å¼€å‘ã€Hooks APIã€çŠ¶æ€ç®¡ç†ã€Context APIã€JSX è¯­æ³•   | â˜…â˜…â˜…â˜…â˜…  | [React å®˜æ–¹æ–‡æ¡£](https://react.dev/learn)                    | â˜…â˜…â˜†â˜†â˜†    |
| **TypeScript** | ç±»å‹ç³»ç»Ÿã€æ¥å£ã€æ³›å‹ã€è£…é¥°å™¨ã€TS ä¸ React é›†æˆ           | â˜…â˜…â˜…â˜…â˜…  | [TypeScript å…¥é—¨æ•™ç¨‹](https://www.typescriptlang.org/docs/handbook/intro.html) | â˜†â˜†â˜†â˜†â˜†    |
| **Ant Design** | ç»„ä»¶åº“ä½¿ç”¨ã€Form/Table é«˜çº§ç”¨æ³•ã€ä¸»é¢˜å®šåˆ¶ã€å›½é™…åŒ–        | â˜…â˜…â˜…â˜…â˜†  | [Ant Design æ–‡æ¡£](https://ant.design/components/overview-cn) | â˜†â˜†â˜†â˜†â˜†    |
| **Umi æ¡†æ¶**   | è·¯ç”±é…ç½®ã€æ’ä»¶æœºåˆ¶ã€æ•°æ®æµç®¡ç†ã€mock æœåŠ¡ã€æ„å»ºéƒ¨ç½²      | â˜…â˜…â˜…â˜…â˜†  | [Umi 4 å®˜æ–¹æ–‡æ¡£](https://umijs.org/docs/guides/getting-started) | â˜†â˜†â˜†â˜†â˜†    |
| **å‰ç«¯å·¥ç¨‹åŒ–** | npm/yarn/pnpmã€Webpack/Viteã€ESLint/Prettierã€Git å·¥ä½œæµ | â˜…â˜…â˜…â˜†â˜†  | [ç°ä»£ JavaScript æ•™ç¨‹](https://zh.javascript.info/)          | â˜…â˜…â˜…â˜…â˜…    |

## Ant Design Pro ç‰¹æœ‰æ¦‚å¿µå­¦ä¹ é‡ç‚¹

### 1. é¡¹ç›®ç»“æ„ä¸æ ¸å¿ƒæ–‡ä»¶
```bash
ant-design-pro/
â”œâ”€â”€ config # Umi é…ç½®
â”œâ”€â”€ mock   # æœ¬åœ°æ¨¡æ‹Ÿæ•°æ®
â”œâ”€â”€ src
â”‚   â”œâ”€â”€ assets       # é™æ€èµ„æº
â”‚   â”œâ”€â”€ components   # å…¨å±€ç»„ä»¶
â”‚   â”œâ”€â”€ layouts      # å¸ƒå±€ç»„ä»¶
â”‚   â”œâ”€â”€ pages        # ä¸šåŠ¡é¡µé¢
â”‚   â”œâ”€â”€ services     # API æœåŠ¡
â”‚   â”œâ”€â”€ utils        # å·¥å…·åº“
â”‚   â”œâ”€â”€ app.tsx      # è¿è¡Œæ—¶é…ç½®
â”‚   â””â”€â”€ access.ts    # æƒé™æ§åˆ¶ ğŸ‘ˆ é‡ç‚¹æ–‡ä»¶
```

### 2. å¿…é¡»æŒæ¡çš„å››å¤§æ ¸å¿ƒæœºåˆ¶

**2.1 è·¯ç”±ä¸èœå•ç³»ç»Ÿ**
- è·¯ç”±é…ç½® (`config/routes.ts`)
- èœå•è‡ªåŠ¨ç”ŸæˆåŸç†
- æƒé™è·¯ç”±å®ç°æ–¹å¼
```typescript
// ç¤ºä¾‹ï¼šå¸¦æƒé™çš„è·¯ç”±é…ç½®
{
  path: '/dashboard',
  name: 'ä»ªè¡¨ç›˜',
  icon: 'DashboardOutlined',
  access: 'canViewDashboard', // æƒé™æ ‡è¯†
  component: './Dashboard',
}
```

**2.2 æƒé™æ§åˆ¶ä½“ç³»**
- `access.ts` æƒé™å®šä¹‰æ–‡ä»¶
- é¡µé¢çº§æƒé™æ§åˆ¶
- ç»„ä»¶çº§æƒé™æ§åˆ¶
```typescript
// src/access.ts
export default function access(initialState: { currentUser?: API.CurrentUser }) {
  const { currentUser } = initialState || {};
  return {
    canAdmin: currentUser?.role === 'admin',
    canUpload: currentUser?.permissions.includes('file:upload'),
  };
}

// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
const access = useAccess();
{access.canUpload && <UploadButton />}
```

**2.3 æ•°æ®æµç®¡ç†**
- Umi çš„ `useModel` é’©å­
- Dva çŠ¶æ€ç®¡ç†ï¼ˆå¯é€‰ï¼‰
- æœåŠ¡è¯·æ±‚å°è£… (`services/`)
```typescript
// ä½¿ç”¨ useModel è·å–å…¨å±€çŠ¶æ€
import { useModel } from 'umi';

export default () => {
  const { initialState } = useModel('@@initialState');
  return <div>{initialState?.currentUser?.name}</div>;
};
```

**2.4 è¯·æ±‚å¤„ç†**
- `request` æ‹¦æˆªå™¨é…ç½® (`app.tsx`)
- é”™è¯¯ç»Ÿä¸€å¤„ç†
- Mock æ•°æ®é›†æˆ
```typescript
// src/app.tsx
export const request: RequestConfig = {
  timeout: 10000,
  errorConfig: {
    adaptor: (resData) => ({
      success: resData.code === 0,
      errorMessage: resData.message,
    }),
  },
  requestInterceptors: [
    (url, options) => {
      const token = localStorage.getItem('token');
      return {
        url,
        options: { 
          ...options, 
          headers: { ...options.headers, Authorization: `Bearer ${token}` }
        },
      };
    },
  ],
};
```

## é«˜æ•ˆå­¦ä¹ è·¯å¾„

```mermaid
graph LR
A[ReactåŸºç¡€] --> B[TypeScript]
B --> C[Ant Designç»„ä»¶]
C --> D[Umiæ¡†æ¶æ ¸å¿ƒ]
D --> E[Ant Design Proé¡¹ç›®ç»“æ„]
E --> F[æƒé™ç³»ç»Ÿå®ç°]
F --> G[æ•°æ®æµç®¡ç†]
G --> H[å®æˆ˜é¡¹ç›®å¼€å‘]
```

> å»ºè®®èŠ±è´¹ 1-2 å‘¨æ—¶é—´ç³»ç»Ÿå­¦ä¹ åå†æ­£å¼å¼€å‘"å¤©æ¢ç³»ç»Ÿ"ã€‚åˆæœŸå¯å…ˆå®ç°ä¸€ä¸ªç®€å•çš„ç”¨æˆ·ç®¡ç†æ¨¡å—ï¼ˆåŒ…å« CRUD å’Œæƒé™æ§åˆ¶ï¼‰ï¼Œè¿™å°†æ¶µç›– Ant Design Pro 80% çš„æ ¸å¿ƒåŠŸèƒ½ã€‚

