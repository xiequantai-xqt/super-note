# 一、DNS协议是什么

DNS（Domain Name System，域名系统）是互联网的一项服务，它作为将域名和IP地址相互映射的一个分布式数据库，能够使人更方便地访问互联网。DNS的主要功能是将人类易读的主机名或网址（如 www.example.com）转换为计算机用于标识和定位设备的数字IP地址（如 93.184.216.34）。这一过程对于网页浏览、电子邮件发送等网络活动至关重要。

# 二、DNS同时使用TCP和UDP协议？

DNS 通常使用 UDP 协议进行查询和响应，因为大部分 DNS 交易较短，UDP 提供了更快的传输速度且无连接的特性适合这种简短的交互。然而，对于数据量较大或需要更可靠传输的情况，如区域传输（zone transfers）或当初始 UDP 包丢失时，DNS 也会使用 TCP 协议以确保数据完整性和可靠性。因此，DNS 可同时依赖于 UDP 和 TCP 来满足不同的需求。

# 三、DNS完整的查询过程

DNS 查询过程一般遵循以下步骤：

1. **递归查询**：当客户端（如Web浏览器）需要解析一个域名时，它首先会向配置的本地DNS解析器（通常是ISP提供的DNS服务器或公共DNS服务器）发送一个递归查询请求。该解析器承诺给客户端一个答案。

2. **根DNS服务器**：如果本地DNS解析器缓存中没有所需信息，它将向根DNS服务器发起查询。根服务器不会直接回答IP地址，而是响应最相关的顶级域（TLD）服务器的信息。

3. **TLD DNS服务器**：接下来，DNS解析器向相应的TLD服务器查询。例如，对于 ".com" 域名，它会联系负责.com域的TLD服务器。TLD服务器会返回特定域名权威名称服务器的信息。

4. **权威DNS服务器**：最后，DNS解析器向权威名称服务器查询。这些服务器保存了指定域名的具体记录，并能提供确切的IP地址。

5. **响应客户端**：一旦获取到IP地址，DNS解析器将结果发送回原始客户端。同时，解析器通常会缓存这条记录一段时间以加速未来对该域名的查询。

6. **使用解析结果**：客户端收到解析后的IP地址后，就可以用它来建立与目标服务器的连接，比如加载网页。

整个过程中，每个阶段的查询可以是迭代的（即每个服务器告诉解析器下一个询问的地方）或递归的（即被询问的服务器负责完成整个查找过程）。在实际操作中，由于缓存的存在，很多查询可以在不触及根或TLD服务器的情况下得到快速解决。

# 四、迭代查询与递归查询

迭代查询（Iterative Query）与递归查询（Recursive Query）是DNS解析过程中两种不同类型的查询方式：

- **迭代查询**：客户端或DNS解析器向DNS服务器请求信息时，如果该服务器不知道确切答案，它不会主动继续查询其他服务器，而是返回给请求者一个指向可能有答案的另一台服务器的引用。然后，请求者需要自己联系这台新服务器来继续查询。这个过程会一直持续直到找到能提供最终答案的权威服务器。

- **递归查询**：在这种情况下，当客户端或DNS解析器向DNS服务器发出请求时，该服务器承诺提供最终的答案。如果它没有现成的答案，它将代表请求者向其他DNS服务器进行查询，直到获得确切的答案并将其返回给最初发出请求的一方。在此过程中，中间的DNS服务器执行必要的迭代查询以获取结果。

大多数情况下，客户端设备会向其配置的DNS解析器发送递归查询，而DNS解析器则使用迭代查询与其他DNS服务器通信以查找完整的答案。

# 五、DNS记录和报文

DNS记录（DNS Records）和DNS报文（DNS Message）是域名系统（DNS）中用于管理和传输信息的关键元素。

- **DNS记录**：这些是存储在DNS服务器上的数据条目，它们定义了关于特定域名的各种信息。常见的DNS记录类型包括：
  - A记录：将主机名映射到IPv4地址。
  - AAAA记录：将主机名映射到IPv6地址。
  - CNAME记录：为一个主机名指定规范名称（别名）。
  - MX记录：指明负责接收该域名邮件的服务器。
  - NS记录：标识负责某一域的权威名称服务器。
  - TXT记录：用于携带文本信息，常用于验证所有权或SPF记录等。
  - SOA记录：标识一个域的起始授权信息。

- **DNS报文**：这是DNS客户端与服务器之间交换的数据格式。一个标准的DNS报文由以下部分组成：
  - **头部（Header）**：包含事务ID、标志位（如查询/响应指示、递归所需/可用标志）、问题数、回答资源记录数、权威服务器记录数和额外记录数。
  - **问题部分（Question Section）**：包含请求解析的域名及所求记录类型。
  - **回答部分（Answer Section）**：包含对问题部分的直接回应，即找到的相关资源记录。
  - **权威部分（Authority Section）**：提供额外的权威信息，如指向负责该域的NS记录。
  - **附加部分（Additional Section）**：可能包含辅助信息，例如与权威部分中的名称服务器相关的A或AAAA记录，以帮助加快后续查询。

DNS协议利用这种结构化的报文格式确保客户端和服务器之间的高效通信，并通过各种类型的DNS记录来组织和传递互联网上关键的命名和寻址信息。

